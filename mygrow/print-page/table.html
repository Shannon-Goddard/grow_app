<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X0XEMR28V2"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-X0XEMR28V2');
    </script>
    <!-- Essential Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- Mobile WebView Optimizations -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-tap-highlight" content="no">
    <!-- Search Engine Controls -->
    <meta name="robots" content="noindex,nofollow">
    <!-- Basic SEO -->
    <title>MyGrow - Print Table</title>
    <meta name="description" content="Print grow schedule">
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="max-age=31536000, public">
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
    <!-- CSS Files with performance attributes -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Add html2canvas for sharing as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
    <style>
        body { padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .actions { margin-bottom: 20px; }
        .actions button { margin-right: 10px; }
        
        /* Theme colors */
        .btn-primary { 
            background-color: #04AA6D; 
            border-color: #04AA6D; 
        }
        .btn-primary:hover, .btn-primary:focus, .btn-primary:active { 
            background-color: #038857; 
            border-color: #038857; 
        }
        
        .btn-secondary { 
            background-color: #343a40; 
            border-color: #343a40; 
        }
        
        .btn-info { 
            background-color: #2a9d8f; 
            border-color: #2a9d8f; 
        }
        
        .btn-outline-primary {
            color: #04AA6D;
            border-color: #04AA6D;
        }
        .btn-outline-primary:hover, .btn-outline-primary:focus, .btn-outline-primary:active {
            background-color: #04AA6D;
            border-color: #04AA6D;
            color: white;
        }

        @media print {
            .actions { display: none; }
            body { padding: 0; margin: 0; }
            
            /* Make table fit on printed page */
            table { 
                width: 100%; 
                font-size: 8pt; /* Smaller font for printing */
                table-layout: fixed; /* Fixed layout for better control */
            }
            
            th, td {
                padding: 2px; /* Reduce padding */
                word-wrap: break-word; /* Allow text to wrap */
                overflow: hidden; /* Hide overflow */
            }
            
            /* Landscape orientation hint */
            @page {
                size: landscape;
            }
            
            /* Hide any overflow */
            .table-responsive {
                overflow: visible !important;
            }
            
            /* Container full width */
            .container {
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="growTitle">Grow Schedule</h1>
        
        <div class="actions">
            <button id="exportBtn" class="btn btn-primary">Export to Excel</button>
            <button onclick="window.print()" class="btn btn-secondary">Print</button>
            <button onclick="shareTable(event)" class="btn btn-info">Download Image</button>
            <a href="../../mygrow/schedule-viewer/schedule-viewer.html" class="btn btn-outline-primary">Back to Information Overload</a>
        </div>
        
        <div class="table-responsive">
            <table id="printTable" class="table table-striped">
                <!-- Table content will be populated by print-table.js -->
            </table>
        </div>
    </div>

    <!-- Download Dialog -->
    <div class="modal fade" id="downloadModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Download Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="downloadProgress">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Creating image...</span>
                        </div>
                        <p class="mt-2">Creating your image...</p>
                    </div>
                    <div id="downloadReady" style="display: none;">
                        <p>Your image is ready!</p>
                        <button id="downloadBtn" class="btn btn-primary">Download</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">GrowApp</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Essential libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- Custom scripts -->
    <script type="module" src="../../mygrow/common/js/indexedDBService.js"></script>
    <script type="module">
    // print-table.js - Renders the filtered table for printing/exporting
    import { IndexedDBService } from '../../mygrow/common/js/indexedDBService.js';
    
    document.addEventListener('DOMContentLoaded', async () => {
        const table = document.getElementById('printTable');
        const exportBtn = document.getElementById('exportBtn');
        
        if (!table) {
            console.error('Table element not found');
            return;
        }
        
        // Function to export table to Excel/CSV
        function exportTable() {
            const rows = Array.from(table.querySelectorAll('tr'));
            let csvContent = "data:text/csv;charset=utf-8,";
            
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                const rowData = cells.map(cell => {
                    // Escape quotes and wrap content in quotes
                    let content = cell.textContent.trim();
                    content = content.replace(/"/g, '""');
                    return `"${content}"`;
                });
                csvContent += rowData.join(',') + '\r\n';
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            const growName = localStorage.getItem('currentGrowName') || 'grow';
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `${growName}_schedule.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Add export button click handler
        if (exportBtn) {
            exportBtn.addEventListener('click', exportTable);
        }
        
        // Toast function
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastBody = toast.querySelector('.toast-body');
            toastBody.textContent = message;
            
            // Remove existing classes and add new one
            toast.className = `toast ${type === 'error' ? 'text-bg-danger' : 'text-bg-success'}`;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
        
        // Share function with dialog
        window.shareTable = function(event) {
            const tableElement = document.getElementById('printTable');
            if (!tableElement) {
                showToast('Table not found', 'error');
                return;
            }
            
            // Show dialog
            const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
            modal.show();
            
            // Reset dialog state
            document.getElementById('downloadProgress').style.display = 'block';
            document.getElementById('downloadReady').style.display = 'none';
            
            // Remove table-responsive wrapper temporarily
            const wrapper = tableElement.closest('.table-responsive');
            const originalOverflow = wrapper ? wrapper.style.overflow : '';
            if (wrapper) {
                wrapper.style.overflow = 'visible';
                wrapper.style.height = 'auto';
            }
            
            html2canvas(tableElement, {
                backgroundColor: '#ffffff',
                scale: 1,
                useCORS: true,
                allowTaint: true,
                logging: false,
                height: tableElement.scrollHeight,
                width: tableElement.scrollWidth,
                scrollX: 0,
                scrollY: 0
            }).then(canvas => {
                // Restore original overflow
                if (wrapper) {
                    wrapper.style.overflow = originalOverflow;
                }
                
                // Show download ready state
                document.getElementById('downloadProgress').style.display = 'none';
                document.getElementById('downloadReady').style.display = 'block';
                
                // Set up download button
                document.getElementById('downloadBtn').onclick = function() {
                    const link = document.createElement('a');
                    const growName = localStorage.getItem('currentGrowName') || 'grow';
                    link.download = `${growName}_schedule.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    modal.hide();
                };
            }).catch(error => {
                // Restore original overflow on error
                if (wrapper) {
                    wrapper.style.overflow = originalOverflow;
                }
                showToast('Error creating image', 'error');
                modal.hide();
            });
        };
    });
    </script>
</body>
</html>